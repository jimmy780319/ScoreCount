<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#f6f8fb" />
  <title>è¨˜åˆ†æ¿</title>

  <style>
    :root{
      --bg:#f6f8fb;
      --bg-glow1: radial-gradient(800px 600px at 20% -10%, rgba(33,118,255,.06), transparent 60%);
      --bg-glow2: radial-gradient(700px 500px at 110% 10%, rgba(11,138,74,.04), transparent 55%);
      --card:#ffffff;
      --card2:#fbfbfe;
      --text:#0b1220;
      --muted:#6c7a93;
      --line:rgba(11,18,32,.06);
      --accent:#2176ff;
      --good:#0b8a4a;
      --warn:#b8860b;
      --bad:#d32f2f;
      --shadow: 0 8px 20px rgba(6,10,20,.06);
      --r:12px;
      --pad:14px;
      --gap:12px;
      --btn:#f0f3f8;
      --btn2:#e6ecf8;
    }
    *{box-sizing:border-box}
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(11,18,32,.06);
      border:1px solid var(--line);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 50;
    }
    h1{font-size:18px; margin:0; letter-spacing:.5px}
    .sub{color:var(--muted); font-size:12px; margin-top:2px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--line);
      background: rgba(11,18,32,.03);
      padding:10px 12px;
      border-radius:999px;
      box-shadow: var(--shadow);
    }
    .pill label{font-size:12px; color:var(--muted)}
    input[type="text"]{
      background: rgba(11,18,32,.03);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      min-width: 170px;
    }
    input[type="text"]::placeholder{color:rgba(168,179,214,.65)}
    button{
      background: var(--btn);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      transition: transform .05s ease, background .2s ease;
      user-select:none;
    }
    button:hover{background: var(--btn2)}
    button:active{transform: translateY(1px)}
    button.primary{background: rgba(90,168,255,.18); border-color: rgba(90,168,255,.35)}
    /* Make the currently selected session more prominent in the sessions list */
    #sessionsWrap .small.primary{
      background: linear-gradient(90deg, rgba(33,118,255,1), rgba(90,168,255,0.95));
      color: #ffffff;
      border-color: rgba(33,118,255,.55);
      box-shadow: 0 8px 20px rgba(33,118,255,.12);
      transform: translateY(-2px);
      font-weight:700;
    }
    #sessionsWrap .small.primary:hover{ box-shadow: 0 10px 26px rgba(33,118,255,.14); }
    button.danger{background: rgba(255,90,122,.14); border-color: rgba(255,90,122,.35)}
    button.ghost{background: transparent}
    button.small{padding:7px 10px; border-radius:10px; font-size:12px}
    .hint{font-size:12px; color:var(--muted)}

    main{max-width:1100px; margin:0 auto; padding: 14px 14px 40px;}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      display:flex; justify-content:space-between; align-items:center;
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--line);
      gap:10px;
    }
    .title{
      display:flex; flex-direction:column; gap:2px;
    }
    .title b{font-size:14px}
    .title span{font-size:12px; color:var(--muted)}
    .card .bd{padding:14px}
    .sep{height:1px; background:var(--line); margin:12px 0}

    .list{display:flex; flex-direction:column; gap:10px}
    .item{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.04);
    }
    .item.dragging{opacity:.55; outline: 2px dashed rgba(90,168,255,.65)}
    .name{display:flex; flex-direction:column; gap:2px}
    .name .main{font-size:14px}
    .name .meta{font-size:12px; color:var(--muted)}
    .score{
      font-variant-numeric: tabular-nums;
      font-size:14px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(11,18,32,.06);
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, color .12s ease;
    }
    /* More prominent style for totals (players & teams) */
    .score.total{
      font-size:18px;
      font-weight:700;
      padding: 8px 14px;
      border-radius:12px;
      min-width:62px;
      text-align:center;
      background: linear-gradient(90deg, rgba(33,118,255,.10), rgba(11,138,74,.04));
      border: 1px solid rgba(33,118,255,.18);
      box-shadow: 0 6px 16px rgba(33,118,255,.08);
      color: var(--text);
    }
    /* Slightly smaller on narrow screens so layout stays neat */
    @media (max-width: 420px){
      .score.total{ font-size:15px; padding:6px 10px; min-width:46px }
    }
    /* Subtle hover/active interaction */
    .score.total:hover{ transform: translateY(-2px); box-shadow: 0 10px 22px rgba(33,118,255,.10) }
    .score.total:active{ transform: translateY(0) }
    
    .playerSwatch{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:8px;border:1px solid rgba(11,18,32,.12);vertical-align:middle}
    .playerNameTag{display:inline-block;padding:4px 8px;border-radius:8px;color:var(--text);font-weight:600;margin-right:6px}
    .playerLabel{display:inline-block; max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .playerSwatch{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:8px;border:1px solid rgba(11,18,32,.12);vertical-align:middle}
    .playerSwatch:focus{outline:2px solid rgba(33,118,255,.35);}
    .btns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .btns button{white-space:nowrap}

    .dropzone{
      padding: 12px;
      border-radius: var(--r);
      border: 1px dashed var(--line);
      background: rgba(11,18,32,.02);
      min-height: 64px;
    }
    .dropzone.over{
      border-color: rgba(33,118,255,.35);
      background: rgba(33,118,255,.04);
    }
    .teams{
      display:grid;
      /* single column layout (always one column) */
      grid-template-columns: 1fr;
      gap: var(--gap);
    }
    /* team cards use a two-column layout: left = title & controls, right = members */
    .teamCard{
      border:1px solid var(--line);
      border-radius: var(--r);
      background: rgba(11,18,32,.02);
      overflow:hidden;
      display:flex;
      gap:12px;
      align-items:flex-start; /* align header and members at the top to avoid overlap */
    }
    .teamCard .th{
      /* left column */
      padding: 12px 12px 12px;
      border-bottom: none;
      flex: 0 0 220px;
      min-width: 120px;
      display:flex;
      align-items:flex-start;
    }
    .teamName{display:flex; flex-direction:column; gap:6px}
    /* show team name on a single line with a max-width (approx. 10 characters) so it can shrink on narrow screens */
    .teamName b{
      font-size:14px;
      display:block;
      max-width:10ch;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      cursor:pointer;
      flex: 0 0 auto;
    }
    .teamName span{font-size:12px; color:var(--muted); display:none}
    .teamCard .tb{padding:12px; flex:1; min-width:0}
    .teamControls{display:flex; gap:8px; align-items:center; flex-shrink:0}
    .teamControls .score{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 8px;
      font-size:14px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(11,18,32,.06);
      min-width:36px;
    }
    /* Ensure team totals are visually prominent like player totals */
    .teamControls .score.total{
      font-size:18px;
      font-weight:700;
      padding:8px 14px;
      border-radius:12px;
      min-width:62px;
      text-align:center;
      background: linear-gradient(90deg, rgba(33,118,255,.10), rgba(11,138,74,.04));
      border: 1px solid rgba(33,118,255,.18);
      box-shadow: 0 6px 16px rgba(33,118,255,.08);
      color: var(--text);
    }
    /* show members inline inside dropzone */
    .teamCard .dropzone{display:flex; gap:8px; flex-wrap:wrap; align-items:center; min-height:48px} 

    /* responsive: stack header + members on narrow screens */
    @media (max-width: 600px){
      .teamCard{flex-direction:column; align-items:flex-start}
      .teamCard .th{flex:0 0 auto}
      .teamCard .dropzone{min-height:48px}
    }

    .teamActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end} 
    .seg{
      display:flex; gap:8px; align-items:center;
      background: rgba(11,18,32,.02);
      border:1px solid var(--line);
      padding:6px;
      border-radius: 999px;
    }
    .seg button{
      border-radius: 999px;
      padding: 8px 12px;
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
    }
    .seg button.active{
      background: rgba(90,168,255,.18);
      border-color: rgba(90,168,255,.35);
      color: var(--text);
    }

    textarea{
      width:100%;
      min-height:120px;
      background: rgba(11,18,32,.03);
      color: var(--text);
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      outline:none;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
    }

    /* page view helpers */
    .page{display:none}
    .page.active{display:block}
    @media (min-width: 900px){
      /* on wide screens keep pages full-width stacked (each page occupies full container width) */
      .pages{display:grid}
      .grid.pages{grid-template-columns: 1fr}
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(18,26,43,.95);
      border:1px solid var(--line);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 50;
      font-size: 12px;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-4px);
    }
    /* temporarily hide export/import controls and IO box */
    #btnExport, #btnImport, #ioBox { display: none !important; }

    /* Responsive compact layout for mobile: reduce paddings, font sizes, and row heights ğŸ”§ */
    @media (max-width: 600px){
      .item{
        padding: 6px 8px;
        border-radius: 10px;
      }
      .name .main{font-size:13px}
      .name .meta{font-size:11px}
      .score{
        font-size:12px;
        padding: 4px 8px;
      }
      .teamCard .th{
        padding: 8px 10px;
      }
      .teamCard .tb{
        padding: 8px;
      }
      .teamName b{font-size:13px; flex:1}
      .teamName span{font-size:11px}
      .dropzone{
        min-height:48px;
        padding:8px;
      }
      input[type="text"]{padding:8px 10px; min-width:120px}
      button{padding:8px 10px}
      .seg button{padding:6px 8px}
      .playerNameTag{padding:2px 6px; font-size:12px}
      .list{gap:8px}
      .teams{gap:8px}
    }

    @media (max-width: 420px){
      .item{padding:5px 6px}
      .teamCard .th{padding:6px 8px}
      .teamCard .tb{padding:6px}
      .score{font-size:11px; padding:3px 6px}
      .title b{font-size:13px}
      .title span{font-size:11px}
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>è¨˜åˆ†æ¿</h1>
        <div class="sub">å»ºç«‹äººå“¡ / å»ºç«‹å ´æ¬¡ï¼ˆæ¯å ´æ¬¡ç¨ç«‹åˆ†çµ„èˆ‡è¨ˆåˆ†ï¼‰ï¼Œåˆ†æ•¸å­˜æœ¬æ©Ÿ</div>
      </div>

      <div style="display:flex; gap:8px; align-items:center">
        <div class="seg" aria-label="é é¢åˆ‡æ›">
          <button id="viewPlayers" class="active small" type="button">äººå“¡</button>
          <button id="viewSessions" class="small" type="button">å ´æ¬¡/åˆ†çµ„</button>
          <button id="viewBoard" class="small" type="button">è¨˜åˆ†æ¿</button>
        </div>
        <div style="display:flex; gap:8px; align-items:center">
          <button id="btnReset" class="danger" type="button" title="æ¸…ç©ºæ‰€æœ‰è³‡æ–™">é‡ç½®</button>
        </div>
      </div>

    </div>
  </div>
</header>

<main>
    <div class="grid pages">
    <!-- äººå“¡ -->
    <section id="playersSection" class="card page">
      <div class="hd">
        <div class="title">
          <b>äººå“¡</b>
          <span>æ–°å¢äººå“¡å¾Œï¼Œå¯æ‹–åˆ°åˆ†çµ„ï¼›å€‹äººåˆ†æ•¸å¯ç›´æ¥åŠ æ¸›</span>
        </div>
      </div>
      <div class="bd">
        <div class="row" style="justify-content:flex-start">
          <input id="playerName" type="text" placeholder="è¼¸å…¥äººå“¡åç¨±" />
          <button id="btnAddPlayer" class="primary" type="button">æ–°å¢äººå“¡</button>
        </div>

        <div class="sep"></div>

        <div id="unassignedZone" class="dropzone" data-team-id="" aria-label="æœªåˆ†çµ„æ‹–æ”¾å€"></div>
      </div>
    </section>

    <!-- åˆ†çµ„ -->
    <section id="sessionsSection" class="card page">
      <div class="hd">
        <div class="title">
          <b>å ´æ¬¡</b>
          <span>å»ºç«‹å ´æ¬¡å¾Œï¼Œé»é¸æŸå ´æ¬¡é€²å…¥è©²å ´æ¬¡åˆ†çµ„èˆ‡è¨ˆåˆ†ï¼ˆæ¯å ´æ¬¡ç¨ç«‹ï¼‰</span>
        </div>
        <div class="row">
          <button id="btnAddSession" class="primary" type="button">æ–°å¢å ´æ¬¡</button>
        </div>
      </div>
      <div class="bd">
        <div id="sessionsWrap" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center"></div>

        <div class="sep"></div>

        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px">
          <input id="teamName" type="text" placeholder="è¼¸å…¥éšŠä¼åç¨±" />
          <button id="btnAddTeam" class="small" type="button">æ–°å¢éšŠä¼</button>
          <button id="btnAutoTeams" class="small" type="button" title="å»ºç«‹æŒ‡å®šæ•¸é‡çš„éšŠä¼ï¼ˆæœƒæ¸…ç©ºæœ¬å ´ç¾æœ‰éšŠä¼ï¼‰">è‡ªå‹•éšŠä¼</button>
          <button id="btnAutoGroup" class="small" type="button" title="æŠŠæœªåˆ†çµ„çš„äººå¹³å‡åˆ†é…åˆ°éšŠä¼">è‡ªå‹•åˆ†çµ„</button>
          <button id="btnRandomGroup" class="small" type="button" title="æŠŠæ‰€æœ‰äººéš¨æ©Ÿåˆ†é…åˆ°æœ¬å ´éšŠä¼">éš¨æ©Ÿåˆ†çµ„</button>
          <button id="btnCloneSession" class="small ghost" type="button" title="è¤‡è£½ç›®å‰å ´æ¬¡é…ç½®é–‹å•Ÿä¸‹ä¸€å ´">ä¸‹ä¸€å ´</button>
        </div>

        <div id="teamsWrap" class="teams" aria-label="éšŠä¼åˆ—è¡¨"></div>
      </div>
    </section>
  </div>

  <div style="height:12px"></div>

  <!-- è¨ˆåˆ†æ¿ -->
  <section id="scoreboardSection" class="card page">
    <div class="hd">
      <div class="title">
        <b>è¨ˆåˆ†æ¿</b>
      </div>
      <div class="row">
        <button id="btnExport" type="button">åŒ¯å‡º JSON</button>
        <button id="btnImport" type="button">åŒ¯å…¥ JSON</button>
      </div>
    </div>

    <div class="bd">
      <div class="row" style="justify-content:flex-start; align-items:flex-start; width:100%">
        <textarea id="ioBox" placeholder="åŒ¯å‡ºæœƒå‡ºç¾åœ¨é€™è£¡ï¼›åŒ¯å…¥è«‹æŠŠ JSON è²¼åœ¨é€™è£¡å†æŒ‰åŒ¯å…¥"></textarea>
      </div>

      <div id="scoreboard" class="list" aria-label="è¨ˆåˆ†åˆ—è¡¨"></div>
    </div>
  </section>
</main>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
(() => {
  const STORAGE_KEY = "scoreboard_state_v1";

  /** @typedef {{id:string,name:string,total:number}} Player */
  /** @typedef {{id:string,name:string,teamScore:number}} Team */
  /** @typedef {{id:string,name:string,teams:Team[],assignments:Object<string,string|null>,playerScores:Object<string,number>,finished?:boolean}} Session */
  /** @typedef {{players:Player[],sessions:Session[],currentSessionId:string|null}} State */

  /** @type {State} */
  let state = loadState();

  // ----- DOM -----
  const playerName = document.getElementById("playerName");
  const btnAddPlayer = document.getElementById("btnAddPlayer");
  const teamName = document.getElementById("teamName");
  const btnAddTeam = document.getElementById("btnAddTeam");
  const btnAutoGroup = document.getElementById("btnAutoGroup");
  const btnRandomGroup = document.getElementById("btnRandomGroup");
  const btnAutoTeams = document.getElementById("btnAutoTeams");
  const btnCloneSession = document.getElementById("btnCloneSession");
  const teamsWrap = document.getElementById("teamsWrap");
  const btnAddSession = document.getElementById("btnAddSession");
  const sessionsWrap = document.getElementById("sessionsWrap");
  const unassignedZone = document.getElementById("unassignedZone");
  const scoreboard = document.getElementById("scoreboard");
  const playersSection = document.getElementById('playersSection');
  const sessionsSection = document.getElementById('sessionsSection');
  const scoreboardSection = document.getElementById('scoreboardSection');
  const viewPlayers = document.getElementById('viewPlayers');
  const viewSessions = document.getElementById('viewSessions');
  const viewBoard = document.getElementById('viewBoard');
  const modePlayer = document.getElementById("modePlayer");
  const modeTeam = document.getElementById("modeTeam");
  const btnReset = document.getElementById("btnReset");
  const btnExport = document.getElementById("btnExport");
  const btnImport = document.getElementById("btnImport");
  const ioBox = document.getElementById("ioBox");
  const toast = document.getElementById("toast");

  // ----- Utils -----
  function uid(prefix="id") {
    return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }
  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }
  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return { players: [], sessions: [], currentSessionId: null };
      const parsed = JSON.parse(raw);
      // migration: old format had players[] and teams[] and mode
      if (parsed && Array.isArray(parsed.players) && Array.isArray(parsed.teams)) {
        // migrate old format: create default session and move teams and assignments
        const defaultSessionId = uid('s');
        const assignments = {};
        for (const p of parsed.players) {
          if (p.teamId) assignments[String(p.id ?? uid('p'))] = String(p.teamId);
        }
        const sess = {
          id: defaultSessionId,
          name: 'é è¨­å ´æ¬¡',
          teams: parsed.teams.map(t => ({ id: String(t.id ?? uid('t')), name: String(t.name ?? 'éšŠä¼'), teamScore: Number.isFinite(t.teamScore) ? t.teamScore : 0 })),
          assignments: assignments,
          playerScores: {}
        };
        const players = parsed.players.map(p => ({ id: String(p.id ?? uid('p')), name: String(p.name ?? 'æœªå‘½å'), total: Number.isFinite(p.score) ? p.score : 0 }));
        return { players, sessions: [sess], currentSessionId: defaultSessionId };
      }
      // expected new format sanity
      if (!parsed || !Array.isArray(parsed.players) || !Array.isArray(parsed.sessions)) {
        return { players: [], sessions: [], currentSessionId: null, currentView: 'players' };
      }
      parsed.players = parsed.players.map(p => ({ id: String(p.id ?? uid('p')), name: String(p.name ?? 'æœªå‘½å'), total: Number.isFinite(p.total ?? p.score) ? (Number.isFinite(p.total) ? p.total : p.score) : 0, color: (p && p.color) ? String(p.color) : pickColorForName(String(p.name ?? '')) }));
      parsed.sessions = parsed.sessions.map(s => ({ id: String(s.id ?? uid('s')), name: String(s.name ?? 'å ´æ¬¡'), teams: Array.isArray(s.teams)?s.teams.map(t=>({ id: String(t.id ?? uid('t')), name: String(t.name ?? 'éšŠä¼'), teamScore: Number.isFinite(t.teamScore)?t.teamScore:0 })) : [], assignments: (s.assignments&&typeof s.assignments==='object')?s.assignments:{}, playerScores: (s.playerScores&&typeof s.playerScores==='object')?s.playerScores:{}, finished: !!s.finished }));
      if (!parsed.currentSessionId && parsed.sessions.length) parsed.currentSessionId = parsed.sessions[0].id;
      if (!parsed.currentView) parsed.currentView = 'players';
      if (!parsed.theme) parsed.theme = 'light';
      return parsed;
    } catch {
      return { players: [], sessions: [], currentSessionId: null, currentView: 'players' };
    }
  }

  function showToast(msg) {
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 1200);
  }

  // Player color helpers
  const PLAYER_PALETTE = ['#e6194b','#3cb44b','#4363d8','#f58231','#911eb4','#46f0f0','#f032e6','#bcf60c','#fabebe','#008080','#e6beff','#9a6324','#fffac8','#800000','#aaffc3','#808000','#ffd8b1','#000075','#a9a9a9','#d7263d','#0b6623'];
  function pickColorForName(name) {
    if (!name) return PLAYER_PALETTE[Math.floor(Math.random()*PLAYER_PALETTE.length)];
    let h = 0;
    for (let i = 0; i < name.length; i++) h = (h * 31 + name.charCodeAt(i)) >>> 0;
    return PLAYER_PALETTE[h % PLAYER_PALETTE.length];
  }

  function hexToRgb(hex) {
    const h = String(hex).replace('#','');
    const bigint = parseInt(h.length === 3 ? h.split('').map(c=>c+c).join('') : h, 16);
    return { r: (bigint >> 16) & 255, g: (bigint >> 8) & 255, b: bigint & 255 };
  }
  function getContrastColor(hex) {
    try {
      const {r,g,b} = hexToRgb(hex);
      // relative luminance approximation
      const yiq = (r*299 + g*587 + b*114) / 1000;
      return yiq >= 150 ? '#0b1220' : '#ffffff';
    } catch (e) { return '#ffffff'; }
  }

  function changePlayerColor(id, color) {
    const p = state.players.find(x => x.id === id);
    if (!p) return;
    p.color = color;
    saveState(); render();
  }

  function getTeamName(teamId) {
    if (!teamId) return "æœªåˆ†çµ„";
    for (const s of state.sessions) {
      const t = s.teams.find(x => x.id === teamId);
      if (t) return t.name;
    }
    return "ï¼ˆå·²åˆªé™¤éšŠä¼ï¼‰";
  }

  function teamMemberCount(teamId) {
    const s = currentSession();
    if (!s) return 0;
    return state.players.filter(p => (s.assignments[p.id] || null) === teamId).length;
  }
  function teamMembers(teamId) {
    const s = currentSession();
    if (!s) return [];
    return state.players.filter(p => (s.assignments[p.id] || null) === teamId);
  }
  function teamMembersScoreSum(teamId) {
    return teamMembers(teamId).reduce((sum, p) => sum + p.total, 0);
  }

  function teamMembersInSession(sessionId, teamId) {
    const s = state.sessions.find(x => x.id === sessionId);
    if (!s) return [];
    return state.players.filter(p => (s.assignments && s.assignments[p.id]) === teamId);
  }

  function getSessionPlayerScore(playerId) {
    const s = currentSession();
    if (!s) return 0;
    return Number.isFinite(s.playerScores[playerId]) ? s.playerScores[playerId] : 0;
  }

  function changeSessionPlayerScore(playerId, delta) {
    const s = currentSession();
    if (!s) return showToast('è«‹å…ˆé¸æ“‡å ´æ¬¡');
    s.playerScores[playerId] = (Number.isFinite(s.playerScores[playerId]) ? s.playerScores[playerId] : 0) + delta;
    // also immediately apply to player's total so scoreboard updates live
    const p = state.players.find(x => x.id === playerId);
    if (p) p.total = (p.total || 0) + delta;
    saveState(); render();
  }

  function currentSession() {
    if (!state.currentSessionId) return null;
    return state.sessions.find(s => s.id === state.currentSessionId) || null;
  }

  // ----- Actions -----
  function addPlayer(name) {
    const n = (name ?? "").trim();
    if (!n) return showToast("è«‹è¼¸å…¥äººå“¡åç¨±");
    // check duplicate (case-insensitive)
    const low = n.toLowerCase();
    if (state.players.some(p => String(p.name).trim().toLowerCase() === low)) return showToast("äººå“¡åç¨±ä¸å¯é‡è¤‡");
    state.players.push({ id: uid("p"), name: n, total: 0, color: pickColorForName(n) });
    saveState(); render();
    playerName.value = "";
    showToast("å·²æ–°å¢äººå“¡");
  }

  function removePlayer(id) {
    state.players = state.players.filter(p => p.id !== id);
    // remove from all session assignments and scores
    for (const s of state.sessions) {
      if (s.assignments && (id in s.assignments)) delete s.assignments[id];
      if (s.playerScores && (id in s.playerScores)) delete s.playerScores[id];
    }
    saveState(); render();
    showToast("å·²åˆªé™¤äººå“¡");
  }

  function addTeam(name) {
    const n = (name ?? "").trim();
    const s = currentSession();
    if (!s) return showToast("è«‹å…ˆå»ºç«‹ä¸¦é¸æ“‡ä¸€å€‹å ´æ¬¡");
    if (!n) return showToast("è«‹è¼¸å…¥éšŠä¼åç¨±");
    // check duplicate team name within the same session (case-insensitive)
    const low = n.toLowerCase();
    if ((s.teams || []).some(t => String(t.name).trim().toLowerCase() === low)) return showToast('æœ¬å ´éšŠä¼åç¨±ä¸å¯é‡è¤‡');
    s.teams.push({ id: uid("t"), name: n, teamScore: 0 });
    saveState(); render();
    teamName.value = "";
    showToast("å·²æ–¼æœ¬å ´æ–°å¢éšŠä¼");
  }

  function autoTeams() {
    const s = currentSession();
    if (!s) return showToast('è«‹å…ˆå»ºç«‹ä¸¦é¸æ“‡ä¸€å€‹å ´æ¬¡');
    const raw = prompt('è«‹è¼¸å…¥è¦å»ºç«‹çš„éšŠä¼æ•¸é‡ï¼ˆæ•´æ•¸ï¼‰ï¼š', '4');
    if (raw === null) return;
    const x = parseInt(raw, 10);
    if (!Number.isFinite(x) || x <= 0) return showToast('è¼¸å…¥ç„¡æ•ˆçš„æ•¸å­—');
    // clear current teams and assignments, create teams, then fairly assign players
    s.teams = [];
    s.assignments = {};
    for (let i = 1; i <= x; i++) {
      s.teams.push({ id: uid('t'), name: `éšŠä¼${i}`, teamScore: 0 });
    }
    // perform balanced random assignment across new teams
    balancedRandomAssign(s, state.players.map(p => p.id), s.teams.map(t => t.id));
    saveState(); render();
    showToast(`å·²å»ºç«‹ ${x} çµ„éšŠä¼ä¸¦è‡ªå‹•åˆ†é…ï¼ˆæœ¬å ´ï¼‰`);
  }

  function randomGroup() {
    const s = currentSession();
    if (!s) return showToast('è«‹å…ˆå»ºç«‹ä¸¦é¸æ“‡ä¸€å€‹å ´æ¬¡');
    if (!s.teams || s.teams.length === 0) return showToast('æœ¬å ´å°šç„¡éšŠä¼');
    // fairly randomize all players into existing teams (balanced counts)
    const ids = state.players.map(p => p.id).slice();
    s.assignments = {};
    balancedRandomAssign(s, ids, s.teams.map(t => t.id));
    saveState(); render();
    showToast('å·²éš¨æ©Ÿä¸”å…¬å¹³åœ°åˆ†é…æ‰€æœ‰äººåˆ°æœ¬å ´éšŠä¼');
  }

  // Helper: fairly and randomly assign playerIds into teamIds for session s.
  // Shuffle players, then compute team sizes (base + optionally 1 extra). The teams
  // that receive the extra 1 are chosen at random so earlier teams are not favored.
  function balancedRandomAssign(s, playerIds, teamIds) {
    if (!Array.isArray(teamIds) || teamIds.length === 0) return;
    const players = (playerIds || []).slice();
    const teams = (teamIds || []).slice();

    // Fisher-Yates shuffle players
    for (let i = players.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      const tmp = players[i]; players[i] = players[j]; players[j] = tmp;
    }

    // Shuffle teams order so extra slots are assigned to random teams
    const teamOrder = teams.slice();
    for (let i = teamOrder.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      const tmp = teamOrder[i]; teamOrder[i] = teamOrder[j]; teamOrder[j] = tmp;
    }

    // Compute base size and remainder (which teams get one extra)
    const base = Math.floor(players.length / teams.length);
    const rem = players.length % teams.length;
    const sizes = {};
    for (const tid of teams) sizes[tid] = base;
    for (let i = 0; i < rem; i++) {
      const tid = teamOrder[i % teamOrder.length];
      sizes[tid] = (sizes[tid] || 0) + 1;
    }

    // Build an array of team slots (team id repeated by its size), then shuffle slots
    const slots = [];
    for (const tid of teams) {
      const cnt = sizes[tid] || 0;
      for (let k = 0; k < cnt; k++) slots.push(tid);
    }
    // Shuffle the slots to remove any positional bias
    for (let i = slots.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      const tmp = slots[i]; slots[i] = slots[j]; slots[j] = tmp;
    }

    // Assign players to shuffled slots one-to-one
    s.assignments = s.assignments || {};
    for (let i = 0; i < players.length; i++) {
      const pid = players[i];
      const tid = slots[i];
      s.assignments[pid] = tid || null;
    }
  }

  function cloneSession() {
    const s = currentSession();
    if (!s) return showToast('è«‹å…ˆå»ºç«‹ä¸¦é¸æ“‡ä¸€å€‹å ´æ¬¡');
    const id = uid('s');
    const idx = state.sessions.length + 1;
    const name = `ç¬¬${idx}å ´`;
    // copy teams with new ids
    const map = {};
    const newTeams = (s.teams || []).map(t => {
      const nid = uid('t');
      map[t.id] = nid;
      return { id: nid, name: t.name, teamScore: 0 };
    });
    const newAssignments = {};
    if (s.assignments) {
      for (const pid of Object.keys(s.assignments)) {
        const oldTid = s.assignments[pid];
        newAssignments[pid] = oldTid ? map[oldTid] || null : null;
      }
    }
    const newSess = { id, name, teams: newTeams, assignments: newAssignments, playerScores: {}, finished: false };
    state.sessions.push(newSess);
    state.currentSessionId = id;
    saveState(); render();
    showToast('å·²è¤‡è£½å ´æ¬¡ï¼ˆä¸åŒ…å«åˆ†æ•¸ï¼‰ä¸¦åˆ‡æ›åˆ°æ–°å ´æ¬¡');
  }

  function removeTeam(id) {
    // æŠŠè©²éšŠæˆå“¡è¸¢å›æœªåˆ†çµ„ï¼ˆåªå½±éŸ¿è©²éšŠæ‰€åœ¨å ´æ¬¡ï¼‰
    for (const s of state.sessions) {
      if (s.teams.find(t => t.id === id)) {
        // remove assignments pointing to this team
        for (const pid of Object.keys(s.assignments || {})) {
          if (s.assignments[pid] === id) s.assignments[pid] = null;
        }
        s.teams = s.teams.filter(t => t.id !== id);
      }
    }
    saveState(); render();
    showToast("å·²åˆªé™¤éšŠä¼ï¼ˆæˆå“¡å·²å›æœªåˆ†çµ„ï¼‰");
  }

  function renameTeam(id) {
    for (const s of state.sessions) {
      const t = s.teams.find(x => x.id === id);
      if (t) {
        const n = prompt("è¼¸å…¥æ–°çš„éšŠä¼åç¨±ï¼š", t.name);
        if (n === null) return;
        const nn = n.trim();
        if (!nn) return showToast("åç¨±ä¸å¯ç©ºç™½");
        // check duplicate within same session (case-insensitive)
        const low = nn.toLowerCase();
        if (s.teams.some(x => x.id !== id && String(x.name).trim().toLowerCase() === low)) return showToast('æœ¬å ´å·²æœ‰ç›¸åŒåç¨±çš„éšŠä¼');
        t.name = nn;
        saveState(); render();
        showToast("å·²æ›´æ–°éšŠä¼åç¨±");
        return;
      }
    }
  }

  function renamePlayer(id) {
    const p = state.players.find(x => x.id === id);
    if (!p) return;
    const n = prompt("è¼¸å…¥æ–°çš„å§“åï¼š", p.name);
    if (n === null) return;
    const nn = n.trim();
    if (!nn) return showToast("åç¨±ä¸å¯ç©ºç™½");
    // check duplicate across players (case-insensitive)
    const low = nn.toLowerCase();
    if (state.players.some(x => x.id !== id && String(x.name).trim().toLowerCase() === low)) return showToast('å·²æœ‰ç›¸åŒåç¨±çš„äººå“¡');
    p.name = nn;
    saveState(); render();
    showToast("å·²æ›´æ–°äººå“¡åç¨±");
  }

  function assignPlayer(playerId, teamIdOrNull) {
    const p = state.players.find(x => x.id === playerId);
    if (!p) return;
    const s = currentSession();
    if (!s) return showToast('è«‹å…ˆå»ºç«‹ä¸¦é¸æ“‡ä¸€å€‹å ´æ¬¡');
    s.assignments = s.assignments || {};
    s.assignments[playerId] = teamIdOrNull;
    saveState(); render();
    showToast(teamIdOrNull ? `å·²åŠ å…¥ ${getTeamName(teamIdOrNull)}` : "å·²å›æœªåˆ†çµ„");
  }

  function autoGroup() {
    const s = currentSession();
    if (!s) return showToast("è«‹å…ˆå»ºç«‹ä¸¦é¸æ“‡ä¸€å€‹å ´æ¬¡");
    if (s.teams.length === 0) return showToast("è«‹å…ˆæ–°å¢è‡³å°‘ 1 å€‹éšŠä¼");
    // unassigned in current session: players without assignment or null
    const unassigned = state.players.filter(p => !s.assignments || !s.assignments[p.id]);
    if (unassigned.length === 0) return showToast("æ²’æœ‰æœªåˆ†çµ„çš„äººå“¡");

    for (const p of unassigned) {
      const sortedTeams = [...s.teams].sort((a,b) => teamMemberCount(a.id) - teamMemberCount(b.id));
      s.assignments[p.id] = sortedTeams[0].id;
    }
    saveState(); render();
    showToast("æœ¬å ´è‡ªå‹•åˆ†çµ„å®Œæˆ");
  }

  function changePlayerScore(id, delta) {
    // change global total score
    const p = state.players.find(x => x.id === id);
    if (!p) return;
    p.total = (p.total + delta);
    saveState(); render();
  }
  function changeTeamScore(id, delta) {
    for (const s of state.sessions) {
      const t = s.teams.find(x => x.id === id);
      if (t) { t.teamScore = (t.teamScore + delta); saveState(); render(); return; }
    }
  }

  function setCurrentSession(id) {
    state.currentSessionId = id;
    saveState(); render();
  }

  function deleteSession(id) {
    const s = state.sessions.find(x => x.id === id);
    if (!s) return;
    if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${s.name}ï¼Ÿæ­¤å‹•ä½œæœƒç§»é™¤è©²å ´æ¬¡çš„éšŠä¼èˆ‡åˆ†æ•¸ï¼Œä½†ä¸æœƒåˆªé™¤äººå“¡ã€‚`)) return;
    state.sessions = state.sessions.filter(x => x.id !== id);
    if (state.currentSessionId === id) {
      state.currentSessionId = state.sessions.length ? state.sessions[0].id : null;
    }
    saveState(); render();
    showToast('å·²åˆªé™¤å ´æ¬¡');
  }

  function resetAll() {
    if (!confirm("ç¢ºå®šè¦é‡ç½®ï¼Ÿæ‰€æœ‰äººå“¡ã€å ´æ¬¡ã€åˆ†æ•¸éƒ½æœƒæ¸…ç©ºã€‚")) return;
    state = { players: [], sessions: [], currentSessionId: null };
    saveState(); render();
    ioBox.value = "";
    showToast("å·²é‡ç½®");
  }

  function exportJSON() {
    ioBox.value = JSON.stringify(state, null, 2);
    ioBox.focus();
    ioBox.select();
    showToast("å·²åŒ¯å‡ºåˆ°æ–‡å­—æ¡†");
  }

  function importJSON() {
    const raw = ioBox.value.trim();
    if (!raw) return showToast("è«‹å…ˆè²¼ä¸Š JSON");
    try {
      const parsed = JSON.parse(raw);
      // store directly, loadState will sanitize/migrate
      localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed));
      state = loadState();
      saveState(); render();
      showToast("åŒ¯å…¥å®Œæˆ");
    } catch (e) {
      showToast("JSON æ ¼å¼éŒ¯èª¤");
    }
  }

  // ----- Drag & Drop -----
  function makePlayerRow(p, {showTeamMeta=true, context='session'} = {}) {
    const el = document.createElement("div");
    el.className = "item";
    // apply player's background color to the whole row (use subtle translucent fill for readability)
    const rowColor = p.color || pickColorForName(p.name);
    try {
      const {r,g,b} = hexToRgb(rowColor);
      el.style.background = `rgba(${r},${g},${b},0.7)`; // subtle tint
    } catch (e) {
      el.style.background = rowColor;
    }
    const rowTextColor = getContrastColor(rowColor);
    el.style.color = rowTextColor;
    // set border color to remain visible against tinted background
    el.style.borderColor = rowTextColor === '#ffffff' ? 'rgba(255,255,255,0.10)' : 'rgba(0,0,0,0.12)';
    el.draggable = true;
    el.dataset.playerId = p.id;

    el.addEventListener("dragstart", (ev) => {
      el.classList.add("dragging");
      ev.dataTransfer.setData("text/plain", p.id);
      ev.dataTransfer.effectAllowed = "move";
    });
    el.addEventListener("dragend", () => el.classList.remove("dragging"));

    const left = document.createElement("div");
    left.className = "name";

    // name text and a small color-swatch to the right (click name to rename, click swatch to change color)
    const colorVal = p.color || pickColorForName(p.name);

    const main = document.createElement("div");
    main.className = "main";
    main.style.display = 'flex';
    main.style.alignItems = 'center';
    main.style.gap = '8px';

    // name text (click to rename)
    const nameSpan = document.createElement('span');
    nameSpan.className = 'playerLabel';
    nameSpan.textContent = p.name;
    nameSpan.title = 'é»æ“Šä¿®æ”¹åç¨±';
    nameSpan.style.cursor = 'pointer';
    nameSpan.style.fontWeight = '600';
    nameSpan.addEventListener('click', () => renamePlayer(p.id));
    nameSpan.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') renamePlayer(p.id); });

    // color swatch (small dot) - clicking opens color picker
    const swatch = document.createElement('span');
    swatch.className = 'playerSwatch';
    swatch.style.background = colorVal;
    swatch.title = 'é»æ“Šä¿®æ”¹é¡è‰²';
    swatch.style.cursor = 'pointer';
    swatch.setAttribute('role', 'button');
    swatch.tabIndex = 0;

    // hidden color input - not display:none so mobile pickers can open
    const colorInput = document.createElement('input');
    colorInput.type = 'color';
    colorInput.value = (p.color && String(p.color).startsWith('#')) ? p.color : pickColorForName(p.name);
    colorInput.style.position = 'absolute';
    colorInput.style.width = '1px';
    colorInput.style.height = '1px';
    colorInput.style.opacity = '0';
    colorInput.style.border = '0';
    colorInput.style.padding = '0';
    colorInput.style.margin = '0';
    colorInput.addEventListener('input', () => changePlayerColor(p.id, colorInput.value));
    colorInput.addEventListener('change', () => changePlayerColor(p.id, colorInput.value));

    // support pointer/touch interactions for mobile
    const openPicker = (ev) => { ev.preventDefault(); colorInput.click(); };
    swatch.addEventListener('click', openPicker);
    swatch.addEventListener('pointerup', openPicker);
    swatch.addEventListener('keydown', (ev) => { if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); colorInput.click(); } });

    main.appendChild(nameSpan);
    main.appendChild(swatch);

    const meta = document.createElement("div");
    meta.className = "meta";
    // make meta slightly muted but visible against the colored background
    meta.style.color = (rowTextColor === '#ffffff') ? 'rgba(255,255,255,0.85)' : 'rgba(0,0,0,0.65)';
    // append color input (hidden) once
    left.appendChild(main);
    left.appendChild(colorInput);
    if (showTeamMeta) left.appendChild(meta);

    const right = document.createElement("div");
    right.className = "btns";
    // ensure action buttons remain readable on colored row
    right.querySelectorAll && right.querySelectorAll('*');

    const spanScore = document.createElement("span");
    spanScore.className = (context === 'session') ? "score" : "score total";
    if (context === 'session') {
      spanScore.textContent = `${getSessionPlayerScore(p.id)}`;
      right.appendChild(spanScore);
      right.appendChild(scoreBtn("+1", () => changeSessionPlayerScore(p.id, +1)));
      right.appendChild(scoreBtn("-1", () => changeSessionPlayerScore(p.id, -1), "small"));
    } else {
      spanScore.textContent = `${p.total}`;
      right.appendChild(spanScore);
      right.appendChild(scoreBtn("+1", () => changePlayerScore(p.id, +1)));
      right.appendChild(scoreBtn("-1", () => changePlayerScore(p.id, -1), "small"));
    }

    // remove / unassign
    if (context === 'session') {
      // in a team/session view the delete button should remove the player from the team (unassign), not delete the person
      const del = createDeleteIconButton('ç§»å‡ºéšŠä¼', () => {
        assignPlayer(p.id, null);
      });
      right.appendChild(del);
    } else {
      const del = createDeleteIconButton('åˆªé™¤äººå“¡', () => removePlayer(p.id));
      right.appendChild(del);
    }

    el.appendChild(left);
    el.appendChild(right);
    return el;
  }

  // previously had finishSession (now removed). Sessions remain open and all scoring updates apply immediately to player totals.

  function scoreBtn(text, onClick, cls="small") {
    const b = document.createElement("button");
    b.className = cls;
    b.textContent = text;
    b.addEventListener("click", onClick);
    return b;
  }

  function createDeleteIconButton(title, onClick) {
    const btn = document.createElement('button');
    btn.className = 'small danger';
    btn.innerHTML = `
      <svg viewBox="0 0 24 24" width="12" height="12" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" style="display:block;">
        <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></line>
        <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></line>
      </svg>
    `;
    btn.title = title;
    btn.setAttribute('aria-label', title);
    btn.style.padding = '6px';
    btn.style.display = 'inline-flex';
    btn.style.alignItems = 'center';
    btn.style.justifyContent = 'center';
    btn.addEventListener('click', onClick);
    return btn;
  }

  function wireDropZone(zoneEl, teamIdOrNull) {
    zoneEl.addEventListener("dragover", (ev) => {
      ev.preventDefault();
      zoneEl.classList.add("over");
      ev.dataTransfer.dropEffect = "move";
    });
    zoneEl.addEventListener("dragleave", () => zoneEl.classList.remove("over"));
    zoneEl.addEventListener("drop", (ev) => {
      ev.preventDefault();
      zoneEl.classList.remove("over");
      const pid = ev.dataTransfer.getData("text/plain");
      if (!pid) return;
      // when dropping to a team in current session, assign; dropping to unassigned removes team
      assignPlayer(pid, teamIdOrNull);
    });
  }

  // ----- Render -----
  function renderUnassigned() {
    unassignedZone.innerHTML = "";
    const s = currentSession();
    // In the äººå“¡ page always show all players (master list), with their currentéšŠä¼æ¨™è¨˜
    const list = [...state.players];
    if (list.length === 0) {
      const empty = document.createElement("div");
      empty.className = "hint";
      empty.textContent = "ç›®å‰æ²’æœ‰æœªåˆ†çµ„äººå“¡ï¼ˆå¯æŠŠéšŠä¼è£¡çš„äººæ‹–å›ä¾†ï¼‰";
      unassignedZone.appendChild(empty);
      return;
    }
    for (const p of list) {
      // show global/player controls in the master list
      unassignedZone.appendChild(makePlayerRow(p, { showTeamMeta: true, context: 'global' }));
    }
  }

  function renderTeams() {
    teamsWrap.innerHTML = "";
    const s = currentSession();
    if (!s || s.teams.length === 0) {
      const msg = document.createElement("div");
      msg.className = "hint";
      msg.textContent = "æœ¬å ´å°šæœªå»ºç«‹éšŠä¼ã€‚å…ˆæ–°å¢éšŠä¼æˆ–å»ºç«‹å ´æ¬¡ã€‚";
      teamsWrap.appendChild(msg);
      return;
    }

    for (const t of s.teams) {
      const tc = document.createElement("div");
      tc.className = "teamCard";

      const th = document.createElement("div");
      th.className = "th";

      const left = document.createElement("div");
      left.className = "teamName";
      const b = document.createElement("b");
      b.textContent = t.name;

      // Build a header row (title on left, controls on right)
      const heading = document.createElement('div');
      heading.style.display = 'flex';
      heading.style.justifyContent = 'space-between';
      heading.style.alignItems = 'center';

      const controls = document.createElement("div");
      controls.className = "teamControls";

      const scoreSpan = document.createElement('span');
      scoreSpan.className = 'score total';
      scoreSpan.textContent = `${Number.isFinite(t.teamScore) ? t.teamScore : 0}`;
      controls.appendChild(scoreSpan);
      controls.appendChild(scoreBtn(`+1`, () => changeTeamScore(t.id, +1)));
      controls.appendChild(scoreBtn(`-1`, () => changeTeamScore(t.id, -1), 'small'));

      const del = createDeleteIconButton('åˆªé™¤éšŠä¼', () => removeTeam(t.id));
      controls.appendChild(del);

      // rename by clicking the team name
      b.addEventListener('click', () => renameTeam(t.id));
      b.setAttribute('title', 'é»æ“Šä¿®æ”¹éšŠå');

      heading.appendChild(b);
      heading.appendChild(controls);

      left.appendChild(heading);

      th.appendChild(left);

      const tb = document.createElement("div");
      tb.className = "tb";

      // Drop zone for team members (rendered to the right)
      const dz = document.createElement("div");
      dz.className = "dropzone";
      dz.dataset.teamId = t.id;
      wireDropZone(dz, t.id);

      const members = teamMembers(t.id);
      if (members.length === 0) {
        const empty = document.createElement("div");
        empty.className = "hint";
        empty.textContent = "æ‹–æ‹‰äººå“¡åˆ°é€™è£¡åŠ å…¥éšŠä¼";
        dz.appendChild(empty);
      } else {
        for (const p of members) dz.appendChild(makePlayerRow(p, { showTeamMeta: true, context: 'session' }));
      }

      tb.appendChild(dz);

      tc.appendChild(th);
      tc.appendChild(tb);
      teamsWrap.appendChild(tc);
    }
  }

  function renderScoreboard() {
    scoreboard.innerHTML = "";
    const title = document.createElement("div");
    title.className = "hint";
    title.textContent = "å€‹äººç¸½åˆ† - ä¾å€‹äººåˆ†æ•¸æ’åºï¼ˆé«˜â†’ä½ï¼‰";
    scoreboard.appendChild(title);

    const list = [...state.players].sort((a,b) => b.total - a.total || a.name.localeCompare(b.name, "zh-Hant"));
    if (list.length === 0) {
      const empty = document.createElement("div");
      empty.className = "hint";
      empty.textContent = "å°šç„¡äººå“¡ã€‚å…ˆåˆ°ä¸Šæ–¹æ–°å¢äººå“¡ã€‚";
      scoreboard.appendChild(empty);
      return;
    }

    for (const p of list) {
      const row = document.createElement("div");
      row.className = "item";
      const left = document.createElement("div");
      left.className = "name";
      // apply full-row background color for player (subtle tint)
      const colorVal = p.color || pickColorForName(p.name);
      try {
        const {r,g,b} = hexToRgb(colorVal);
        row.style.background = `rgba(${r},${g},${b},0.10)`;
      } catch (e) {
        row.style.background = colorVal;
      }
      const contrast = getContrastColor(colorVal);
      row.style.color = contrast;
      row.style.borderColor = contrast === '#ffffff' ? 'rgba(255,255,255,0.10)' : 'rgba(0,0,0,0.12)';
      const badgeHtml = `<span class="playerNameTag" style="background:${escapeHtml(colorVal)};color:${escapeHtml(contrast)}">${escapeHtml(p.name)}</span>`;
      // name and session scores inline (sessions to the right of the name)
      const mainRow = document.createElement('div');
      mainRow.className = 'main';
      mainRow.style.display = 'flex';
      mainRow.style.alignItems = 'center';
      mainRow.style.gap = '8px';

      const nameSpan = document.createElement('span');
      nameSpan.innerHTML = badgeHtml;

      const sessionPills = document.createElement('div');
      sessionPills.style.display = 'flex';
      sessionPills.style.gap = '6px';
      sessionPills.style.flexWrap = 'wrap';
      sessionPills.style.marginLeft = '6px';

      for (const ss of state.sessions) {
        const val = (ss && ss.playerScores && Number.isFinite(ss.playerScores[p.id])) ? ss.playerScores[p.id] : 0;
        const b = document.createElement('span');
        b.className = 'pill';
        b.style.padding = '6px 8px';
        b.style.fontSize = '12px';
        b.textContent = `${ss.name}: ${val}`;
        sessionPills.appendChild(b);
      }

      mainRow.appendChild(nameSpan);
      mainRow.appendChild(sessionPills);
      left.appendChild(mainRow);

      const right = document.createElement("div");
      right.className = "btns";
      const scoreSpan = document.createElement("span");
      scoreSpan.className = "score total";
      scoreSpan.textContent = `${p.total}`;
      right.appendChild(scoreSpan);
      row.appendChild(left);
      row.appendChild(right);
      scoreboard.appendChild(row);
    }
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function renderModeButtons() {
    // no-op: removed mode toggle
  }

  function render() {
    renderModeButtons();
    renderUnassigned();
    renderTeams();
    renderScoreboard();
    renderSessions();
    // apply view
    setView(state.currentView || 'players');
  }

  function setView(v){
    // v: 'players' | 'sessions' | 'board'
    state.currentView = v;
    // buttons
    viewPlayers.classList.toggle('active', v === 'players');
    viewSessions.classList.toggle('active', v === 'sessions');
    viewBoard.classList.toggle('active', v === 'board');
    // sections
    playersSection.classList.toggle('active', v === 'players');
    sessionsSection.classList.toggle('active', v === 'sessions');
    scoreboardSection.classList.toggle('active', v === 'board');
    saveState();
  }

  // ----- Wire events -----
  btnAddPlayer.addEventListener("click", () => addPlayer(playerName.value));
  playerName.addEventListener("keydown", (e) => { if (e.key === "Enter") addPlayer(playerName.value); });

  btnAddTeam.addEventListener("click", () => addTeam(teamName.value));
  teamName.addEventListener("keydown", (e) => { if (e.key === "Enter") addTeam(teamName.value); });

  btnAutoGroup.addEventListener("click", autoGroup);
  btnRandomGroup.addEventListener('click', randomGroup);
  btnAutoTeams.addEventListener('click', autoTeams);
  btnCloneSession.addEventListener('click', cloneSession);
  btnAddSession.addEventListener("click", () => addSession());
  btnAutoGroup.addEventListener("click", autoGroup);
  viewPlayers.addEventListener('click', () => setView('players'));
  viewSessions.addEventListener('click', () => setView('sessions'));
  viewBoard.addEventListener('click', () => setView('board'));
  btnReset.addEventListener("click", resetAll);
  btnExport.addEventListener("click", exportJSON);
  btnImport.addEventListener("click", importJSON);

  // dropzone for unassigned
  wireDropZone(unassignedZone, null);

  // sessions render/wire
  function addSession() {
    // auto-numbered sessions
    const id = uid('s');
    const idx = state.sessions.length + 1;
    const name = `ç¬¬${idx}å ´`;
    state.sessions.push({ id, name: name, teams: [], assignments: {}, playerScores: {}, finished: false });
    state.currentSessionId = id;
    saveState(); render();
    showToast('å·²æ–°å¢å ´æ¬¡ä¸¦åˆ‡æ›åˆ°è©²å ´');
  }

  function renderSessions() {
    sessionsWrap.innerHTML = '';
    if (state.sessions.length === 0) {
      const hint = document.createElement('div');
      hint.className = 'hint';
      hint.textContent = 'å°šç„¡å ´æ¬¡ï¼Œè«‹æ–°å¢å ´æ¬¡å¾Œé–‹å§‹æœ¬å ´åˆ†çµ„èˆ‡è¨ˆåˆ†';
      sessionsWrap.appendChild(hint);
      return;
    }
    for (const s of state.sessions) {
      const wrap = document.createElement('div');
      wrap.style.display = 'flex';
      wrap.style.gap = '6px';
      wrap.style.alignItems = 'center';

      const b = document.createElement('button');
      b.className = 'small';
      b.textContent = s.name;
      if (s.id === state.currentSessionId) {
        b.classList.add('primary');
        b.setAttribute('aria-current', 'true');
        b.title = 'ç›®å‰é¸æ“‡çš„å ´æ¬¡';
      } else {
        b.removeAttribute('aria-current');
      }
      b.addEventListener('click', () => setCurrentSession(s.id));

      const delSess = createDeleteIconButton('åˆªé™¤å ´æ¬¡', (ev) => { ev.stopPropagation(); deleteSession(s.id); });

      wrap.appendChild(b);
      wrap.appendChild(delSess);
      sessionsWrap.appendChild(wrap);
    }
  }

  // initial render
  render();
})();
</script>

</body>
</html>
