<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f19" />
  <title>記分板</title>

  <style>
    :root{
      --bg:#0b0f19;
      --card:#121a2b;
      --card2:#0f1626;
      --text:#e8eefc;
      --muted:#a8b3d6;
      --line:rgba(255,255,255,.10);
      --accent:#5aa8ff;
      --good:#3ddc97;
      --warn:#ffd166;
      --bad:#ff5a7a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r:16px;
      --pad:14px;
      --gap:12px;
      --btn:#1b2742;
      --btn2:#22335a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Helvetica, Arial;
      background: radial-gradient(1200px 900px at 20% -20%, rgba(90,168,255,.25), transparent 60%),
                  radial-gradient(900px 700px at 110% 20%, rgba(61,220,151,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    header{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,15,25,.92), rgba(11,15,25,.55));
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1100px; margin:0 auto; padding: 14px 14px 18px;}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
    }
    h1{font-size:18px; margin:0; letter-spacing:.5px}
    .sub{color:var(--muted); font-size:12px; margin-top:2px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--line);
      background: rgba(18,26,43,.65);
      padding:10px 12px;
      border-radius:999px;
      box-shadow: var(--shadow);
    }
    .pill label{font-size:12px; color:var(--muted)}
    input[type="text"]{
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      min-width: 170px;
    }
    input[type="text"]::placeholder{color:rgba(168,179,214,.65)}
    button{
      background: var(--btn);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      transition: transform .05s ease, background .2s ease;
      user-select:none;
    }
    button:hover{background: var(--btn2)}
    button:active{transform: translateY(1px)}
    button.primary{background: rgba(90,168,255,.18); border-color: rgba(90,168,255,.35)}
    button.danger{background: rgba(255,90,122,.14); border-color: rgba(255,90,122,.35)}
    button.ghost{background: transparent}
    button.small{padding:7px 10px; border-radius:10px; font-size:12px}
    .hint{font-size:12px; color:var(--muted)}

    main{max-width:1100px; margin:0 auto; padding: 14px 14px 40px;}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(18,26,43,.92), rgba(15,22,38,.92));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      display:flex; justify-content:space-between; align-items:center;
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--line);
      gap:10px;
    }
    .title{
      display:flex; flex-direction:column; gap:2px;
    }
    .title b{font-size:14px}
    .title span{font-size:12px; color:var(--muted)}
    .card .bd{padding:14px}
    .sep{height:1px; background:var(--line); margin:12px 0}

    .list{display:flex; flex-direction:column; gap:10px}
    .item{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.04);
    }
    .item.dragging{opacity:.55; outline: 2px dashed rgba(90,168,255,.65)}
    .name{display:flex; flex-direction:column; gap:2px}
    .name .main{font-size:14px}
    .name .meta{font-size:12px; color:var(--muted)}
    .score{
      font-variant-numeric: tabular-nums;
      font-size:14px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
    }
    .btns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .btns button{white-space:nowrap}

    .dropzone{
      padding: 12px;
      border-radius: var(--r);
      border: 1px dashed rgba(168,179,214,.35);
      background: rgba(255,255,255,.03);
      min-height: 64px;
    }
    .dropzone.over{
      border-color: rgba(90,168,255,.75);
      background: rgba(90,168,255,.08);
    }
    .teams{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
    }
    @media (max-width: 700px){
      .teams{grid-template-columns:1fr}
    }
    .teamCard{
      border:1px solid var(--line);
      border-radius: var(--r);
      background: rgba(255,255,255,.03);
      overflow:hidden;
    }
    .teamCard .th{
      display:flex; justify-content:space-between; align-items:center;
      padding: 12px 12px 10px;
      border-bottom:1px solid var(--line);
      gap:10px;
    }
    .teamName{display:flex; flex-direction:column; gap:2px}
    .teamName b{font-size:14px}
    .teamName span{font-size:12px; color:var(--muted)}
    .teamCard .tb{padding:12px}
    .teamActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .seg{
      display:flex; gap:8px; align-items:center;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      padding:6px;
      border-radius: 999px;
    }
    .seg button{
      border-radius: 999px;
      padding: 8px 12px;
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
    }
    .seg button.active{
      background: rgba(90,168,255,.18);
      border-color: rgba(90,168,255,.35);
      color: var(--text);
    }

    textarea{
      width:100%;
      min-height:120px;
      background: rgba(0,0,0,.20);
      color: var(--text);
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      outline:none;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(18,26,43,.95);
      border:1px solid var(--line);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 50;
      font-size: 12px;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-4px);
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>記分板（自用版）</h1>
        <div class="sub">建立人員 / 建立分組 / 拖拉分組 / 個人或團體計分（資料存本機）</div>
      </div>

      <div class="row">
        <div class="seg" aria-label="計分模式">
          <button id="modePlayer" class="active" type="button">個人</button>
          <button id="modeTeam" type="button">團體</button>
        </div>

        <button id="btnReset" class="danger" type="button" title="清空所有資料">重置</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <!-- 人員 -->
    <section class="card">
      <div class="hd">
        <div class="title">
          <b>人員</b>
          <span>新增人員後，可拖到分組；個人分數在個人模式可直接加減</span>
        </div>
      </div>
      <div class="bd">
        <div class="row" style="justify-content:flex-start">
          <input id="playerName" type="text" placeholder="輸入人員名稱" />
          <button id="btnAddPlayer" class="primary" type="button">新增人員</button>
        </div>

        <div class="sep"></div>

        <div class="title" style="margin-bottom:8px">
          <b style="font-size:13px">未分組（可拖拉到下方隊伍）</b>
          <span>把人拖到某個隊伍卡片即可加入；也可拖回未分組</span>
        </div>
        <div id="unassignedZone" class="dropzone" data-team-id="" aria-label="未分組拖放區"></div>

        <div class="sep"></div>

        <div class="hint">小技巧：在 iPhone Safari「分享 → 加入主畫面」，就像 App 一樣開啟。</div>
      </div>
    </section>

    <!-- 分組 -->
    <section class="card">
      <div class="hd">
        <div class="title">
          <b>分組</b>
          <span>支援手動新增/刪除與自動分組</span>
        </div>
        <div class="row">
          <button id="btnAutoGroup" class="primary" type="button" title="把未分組的人平均分配到隊伍">自動分組</button>
        </div>
      </div>
      <div class="bd">
        <div class="row" style="justify-content:flex-start">
          <input id="teamName" type="text" placeholder="輸入隊伍名稱" />
          <button id="btnAddTeam" class="primary" type="button">新增隊伍</button>
        </div>

        <div class="sep"></div>

        <div id="teamsWrap" class="teams" aria-label="隊伍列表"></div>
      </div>
    </section>
  </div>

  <div style="height:12px"></div>

  <!-- 計分板 -->
  <section class="card">
    <div class="hd">
      <div class="title">
        <b>計分板</b>
        <span>個人模式：加減個人分數；團體模式：加減隊伍分數（獨立）</span>
      </div>
      <div class="row">
        <button id="btnExport" type="button">匯出 JSON</button>
        <button id="btnImport" type="button">匯入 JSON</button>
      </div>
    </div>

    <div class="bd">
      <div class="row" style="justify-content:flex-start; align-items:flex-start; width:100%">
        <textarea id="ioBox" placeholder="匯出會出現在這裡；匯入請把 JSON 貼在這裡再按匯入"></textarea>
      </div>

      <div class="sep"></div>

      <div id="scoreboard" class="list" aria-label="計分列表"></div>
    </div>
  </section>
</main>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
(() => {
  const STORAGE_KEY = "scoreboard_state_v1";

  /** @typedef {{id:string,name:string,score:number,teamId:string|null}} Player */
  /** @typedef {{id:string,name:string,teamScore:number}} Team */
  /** @typedef {{players:Player[],teams:Team[],mode:"player"|"team"}} State */

  /** @type {State} */
  let state = loadState();

  // ----- DOM -----
  const playerName = document.getElementById("playerName");
  const btnAddPlayer = document.getElementById("btnAddPlayer");
  const teamName = document.getElementById("teamName");
  const btnAddTeam = document.getElementById("btnAddTeam");
  const btnAutoGroup = document.getElementById("btnAutoGroup");
  const teamsWrap = document.getElementById("teamsWrap");
  const unassignedZone = document.getElementById("unassignedZone");
  const scoreboard = document.getElementById("scoreboard");
  const modePlayer = document.getElementById("modePlayer");
  const modeTeam = document.getElementById("modeTeam");
  const btnReset = document.getElementById("btnReset");
  const btnExport = document.getElementById("btnExport");
  const btnImport = document.getElementById("btnImport");
  const ioBox = document.getElementById("ioBox");
  const toast = document.getElementById("toast");

  // ----- Utils -----
  function uid(prefix="id") {
    return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }
  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }
  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return { players: [], teams: [], mode: "player" };
      const parsed = JSON.parse(raw);
      // minimal sanity
      if (!parsed || !Array.isArray(parsed.players) || !Array.isArray(parsed.teams)) {
        return { players: [], teams: [], mode: "player" };
      }
      if (parsed.mode !== "player" && parsed.mode !== "team") parsed.mode = "player";
      // fill defaults
      parsed.players = parsed.players.map(p => ({
        id: String(p.id ?? uid("p")),
        name: String(p.name ?? "未命名"),
        score: Number.isFinite(p.score) ? p.score : 0,
        teamId: (p.teamId === null || p.teamId === undefined || p.teamId === "") ? null : String(p.teamId)
      }));
      parsed.teams = parsed.teams.map(t => ({
        id: String(t.id ?? uid("t")),
        name: String(t.name ?? "隊伍"),
        teamScore: Number.isFinite(t.teamScore) ? t.teamScore : 0
      }));
      return parsed;
    } catch {
      return { players: [], teams: [], mode: "player" };
    }
  }

  function showToast(msg) {
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 1200);
  }

  function getTeamName(teamId) {
    if (!teamId) return "未分組";
    const t = state.teams.find(x => x.id === teamId);
    return t ? t.name : "（已刪除隊伍）";
  }

  function teamMemberCount(teamId) {
    return state.players.filter(p => p.teamId === teamId).length;
  }
  function teamMembers(teamId) {
    return state.players.filter(p => p.teamId === teamId);
  }
  function teamMembersScoreSum(teamId) {
    return teamMembers(teamId).reduce((sum, p) => sum + p.score, 0);
  }

  // ----- Actions -----
  function addPlayer(name) {
    const n = (name ?? "").trim();
    if (!n) return showToast("請輸入人員名稱");
    state.players.push({ id: uid("p"), name: n, score: 0, teamId: null });
    saveState(); render();
    playerName.value = "";
    showToast("已新增人員");
  }

  function removePlayer(id) {
    state.players = state.players.filter(p => p.id !== id);
    saveState(); render();
    showToast("已刪除人員");
  }

  function addTeam(name) {
    const n = (name ?? "").trim();
    if (!n) return showToast("請輸入隊伍名稱");
    state.teams.push({ id: uid("t"), name: n, teamScore: 0 });
    saveState(); render();
    teamName.value = "";
    showToast("已新增隊伍");
  }

  function removeTeam(id) {
    // 把該隊成員踢回未分組
    state.players = state.players.map(p => p.teamId === id ? ({...p, teamId: null}) : p);
    state.teams = state.teams.filter(t => t.id !== id);
    saveState(); render();
    showToast("已刪除隊伍（成員已回未分組）");
  }

  function renameTeam(id) {
    const t = state.teams.find(x => x.id === id);
    if (!t) return;
    const n = prompt("輸入新的隊伍名稱：", t.name);
    if (n === null) return;
    const nn = n.trim();
    if (!nn) return showToast("名稱不可空白");
    t.name = nn;
    saveState(); render();
    showToast("已更新隊伍名稱");
  }

  function assignPlayer(playerId, teamIdOrNull) {
    const p = state.players.find(x => x.id === playerId);
    if (!p) return;
    p.teamId = teamIdOrNull;
    saveState(); render();
    showToast(teamIdOrNull ? `已加入 ${getTeamName(teamIdOrNull)}` : "已回未分組");
  }

  function autoGroup() {
    if (state.teams.length === 0) return showToast("請先新增至少 1 個隊伍");
    const unassigned = state.players.filter(p => !p.teamId);
    if (unassigned.length === 0) return showToast("沒有未分組的人員");

    // 每次把一個人分到目前人最少的隊伍（平衡）
    for (const p of unassigned) {
      const sortedTeams = [...state.teams].sort((a,b) => teamMemberCount(a.id) - teamMemberCount(b.id));
      p.teamId = sortedTeams[0].id;
    }
    saveState(); render();
    showToast("自動分組完成");
  }

  function changePlayerScore(id, delta) {
    const p = state.players.find(x => x.id === id);
    if (!p) return;
    p.score = (p.score + delta);
    saveState(); render();
  }
  function changeTeamScore(id, delta) {
    const t = state.teams.find(x => x.id === id);
    if (!t) return;
    t.teamScore = (t.teamScore + delta);
    saveState(); render();
  }

  function setMode(mode) {
    state.mode = mode;
    saveState(); render();
  }

  function resetAll() {
    if (!confirm("確定要重置？所有人員、隊伍、分數都會清空。")) return;
    state = { players: [], teams: [], mode: "player" };
    saveState(); render();
    ioBox.value = "";
    showToast("已重置");
  }

  function exportJSON() {
    ioBox.value = JSON.stringify(state, null, 2);
    ioBox.focus();
    ioBox.select();
    showToast("已匯出到文字框");
  }

  function importJSON() {
    const raw = ioBox.value.trim();
    if (!raw) return showToast("請先貼上 JSON");
    try {
      const parsed = JSON.parse(raw);
      // reuse loadState-like sanitation on this object
      localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed));
      state = loadState();
      saveState(); render();
      showToast("匯入完成");
    } catch (e) {
      showToast("JSON 格式錯誤");
    }
  }

  // ----- Drag & Drop -----
  function makePlayerRow(p, {showTeamMeta=true} = {}) {
    const el = document.createElement("div");
    el.className = "item";
    el.draggable = true;
    el.dataset.playerId = p.id;

    el.addEventListener("dragstart", (ev) => {
      el.classList.add("dragging");
      ev.dataTransfer.setData("text/plain", p.id);
      ev.dataTransfer.effectAllowed = "move";
    });
    el.addEventListener("dragend", () => el.classList.remove("dragging"));

    const left = document.createElement("div");
    left.className = "name";
    const main = document.createElement("div");
    main.className = "main";
    main.textContent = p.name;
    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = showTeamMeta ? `分組：${getTeamName(p.teamId)}` : "";
    left.appendChild(main);
    if (showTeamMeta) left.appendChild(meta);

    const right = document.createElement("div");
    right.className = "btns";

    const s = document.createElement("span");
    s.className = "score";
    s.textContent = `${p.score}`;
    right.appendChild(s);

    // score buttons (player)
    if (state.mode === "player") {
      right.appendChild(scoreBtn("+1", () => changePlayerScore(p.id, +1)));
      right.appendChild(scoreBtn("+2", () => changePlayerScore(p.id, +2)));
      right.appendChild(scoreBtn("+5", () => changePlayerScore(p.id, +5)));
      right.appendChild(scoreBtn("-1", () => changePlayerScore(p.id, -1), "small"));
    }

    // remove
    const del = document.createElement("button");
    del.className = "small danger";
    del.textContent = "刪除";
    del.addEventListener("click", () => removePlayer(p.id));
    right.appendChild(del);

    el.appendChild(left);
    el.appendChild(right);
    return el;
  }

  function scoreBtn(text, onClick, cls="small") {
    const b = document.createElement("button");
    b.className = cls;
    b.textContent = text;
    b.addEventListener("click", onClick);
    return b;
  }

  function wireDropZone(zoneEl, teamIdOrNull) {
    zoneEl.addEventListener("dragover", (ev) => {
      ev.preventDefault();
      zoneEl.classList.add("over");
      ev.dataTransfer.dropEffect = "move";
    });
    zoneEl.addEventListener("dragleave", () => zoneEl.classList.remove("over"));
    zoneEl.addEventListener("drop", (ev) => {
      ev.preventDefault();
      zoneEl.classList.remove("over");
      const pid = ev.dataTransfer.getData("text/plain");
      if (!pid) return;
      assignPlayer(pid, teamIdOrNull);
    });
  }

  // ----- Render -----
  function renderUnassigned() {
    unassignedZone.innerHTML = "";
    const list = state.players.filter(p => !p.teamId);
    if (list.length === 0) {
      const empty = document.createElement("div");
      empty.className = "hint";
      empty.textContent = "目前沒有未分組人員（可把隊伍裡的人拖回來）";
      unassignedZone.appendChild(empty);
      return;
    }
    for (const p of list) {
      unassignedZone.appendChild(makePlayerRow(p));
    }
  }

  function renderTeams() {
    teamsWrap.innerHTML = "";
    if (state.teams.length === 0) {
      const msg = document.createElement("div");
      msg.className = "hint";
      msg.textContent = "尚未建立隊伍。你可以只用未分組 + 個人計分，也可以新增隊伍後拖拉分組。";
      teamsWrap.appendChild(msg);
      return;
    }

    for (const t of state.teams) {
      const tc = document.createElement("div");
      tc.className = "teamCard";

      const th = document.createElement("div");
      th.className = "th";

      const left = document.createElement("div");
      left.className = "teamName";
      const b = document.createElement("b");
      b.textContent = t.name;

      const memberCnt = teamMemberCount(t.id);
      const sumPlayers = teamMembersScoreSum(t.id);
      const meta = document.createElement("span");
      meta.textContent = `人數：${memberCnt}｜隊伍分：${t.teamScore}｜個人加總：${sumPlayers}`;
      left.appendChild(b);
      left.appendChild(meta);

      const right = document.createElement("div");
      right.className = "teamActions";

      const rename = document.createElement("button");
      rename.className = "small";
      rename.textContent = "改名";
      rename.addEventListener("click", () => renameTeam(t.id));

      const del = document.createElement("button");
      del.className = "small danger";
      del.textContent = "刪隊";
      del.addEventListener("click", () => removeTeam(t.id));

      right.appendChild(rename);
      right.appendChild(del);

      th.appendChild(left);
      th.appendChild(right);

      const tb = document.createElement("div");
      tb.className = "tb";

      // Drop zone for team members
      const dz = document.createElement("div");
      dz.className = "dropzone";
      dz.dataset.teamId = t.id;
      wireDropZone(dz, t.id);

      const members = teamMembers(t.id);
      if (members.length === 0) {
        const empty = document.createElement("div");
        empty.className = "hint";
        empty.textContent = "拖拉人員到這裡加入隊伍";
        dz.appendChild(empty);
      } else {
        for (const p of members) dz.appendChild(makePlayerRow(p));
      }

      // team score buttons (team mode)
      if (state.mode === "team") {
        const pad = document.createElement("div");
        pad.style.marginTop = "10px";
        pad.style.display = "flex";
        pad.style.gap = "8px";
        pad.style.flexWrap = "wrap";

        pad.appendChild(scoreBtn(`隊伍 +1`, () => changeTeamScore(t.id, +1)));
        pad.appendChild(scoreBtn(`隊伍 +2`, () => changeTeamScore(t.id, +2)));
        pad.appendChild(scoreBtn(`隊伍 +5`, () => changeTeamScore(t.id, +5)));
        pad.appendChild(scoreBtn(`隊伍 -1`, () => changeTeamScore(t.id, -1)));

        tb.appendChild(pad);
        const hint = document.createElement("div");
        hint.className = "hint";
        hint.style.marginTop = "8px";
        hint.textContent = "團體模式：上面按鈕會改「隊伍分」（獨立於個人分數）。";
        tb.appendChild(hint);
      }

      tb.appendChild(dz);

      tc.appendChild(th);
      tc.appendChild(tb);
      teamsWrap.appendChild(tc);
    }
  }

  function renderScoreboard() {
    scoreboard.innerHTML = "";

    if (state.mode === "player") {
      const title = document.createElement("div");
      title.className = "hint";
      title.textContent = "個人模式：依個人分數排序（高→低）";
      scoreboard.appendChild(title);

      const list = [...state.players].sort((a,b) => b.score - a.score || a.name.localeCompare(b.name, "zh-Hant"));
      if (list.length === 0) {
        const empty = document.createElement("div");
        empty.className = "hint";
        empty.textContent = "尚無人員。先到上方新增人員。";
        scoreboard.appendChild(empty);
        return;
      }

      for (const p of list) {
        const row = document.createElement("div");
        row.className = "item";
        const left = document.createElement("div");
        left.className = "name";
        left.innerHTML = `<div class="main">${escapeHtml(p.name)}</div><div class="meta">分組：${escapeHtml(getTeamName(p.teamId))}</div>`;
        const right = document.createElement("div");
        right.className = "btns";
        const s = document.createElement("span");
        s.className = "score";
        s.textContent = `${p.score}`;
        right.appendChild(s);
        right.appendChild(scoreBtn("+1", () => changePlayerScore(p.id, +1)));
        right.appendChild(scoreBtn("+2", () => changePlayerScore(p.id, +2)));
        right.appendChild(scoreBtn("+5", () => changePlayerScore(p.id, +5)));
        right.appendChild(scoreBtn("-1", () => changePlayerScore(p.id, -1)));
        row.appendChild(left);
        row.appendChild(right);
        scoreboard.appendChild(row);
      }
    } else {
      const title = document.createElement("div");
      title.className = "hint";
      title.textContent = "團體模式：依隊伍分數排序（高→低）";
      scoreboard.appendChild(title);

      if (state.teams.length === 0) {
        const empty = document.createElement("div");
        empty.className = "hint";
        empty.textContent = "尚無隊伍。先到上方新增隊伍（或切回個人模式）。";
        scoreboard.appendChild(empty);
        return;
      }

      const list = [...state.teams].sort((a,b) => b.teamScore - a.teamScore || a.name.localeCompare(b.name, "zh-Hant"));
      for (const t of list) {
        const row = document.createElement("div");
        row.className = "item";

        const left = document.createElement("div");
        left.className = "name";
        const cnt = teamMemberCount(t.id);
        const sum = teamMembersScoreSum(t.id);
        left.innerHTML = `<div class="main">${escapeHtml(t.name)}</div><div class="meta">人數：${cnt}｜隊伍分：${t.teamScore}｜個人加總：${sum}</div>`;

        const right = document.createElement("div");
        right.className = "btns";
        const s = document.createElement("span");
        s.className = "score";
        s.textContent = `${t.teamScore}`;
        right.appendChild(s);
        right.appendChild(scoreBtn("+1", () => changeTeamScore(t.id, +1)));
        right.appendChild(scoreBtn("+2", () => changeTeamScore(t.id, +2)));
        right.appendChild(scoreBtn("+5", () => changeTeamScore(t.id, +5)));
        right.appendChild(scoreBtn("-1", () => changeTeamScore(t.id, -1)));
        row.appendChild(left);
        row.appendChild(right);

        scoreboard.appendChild(row);
      }
    }
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function renderModeButtons() {
    const isPlayer = state.mode === "player";
    modePlayer.classList.toggle("active", isPlayer);
    modeTeam.classList.toggle("active", !isPlayer);
  }

  function render() {
    renderModeButtons();
    renderUnassigned();
    renderTeams();
    renderScoreboard();
  }

  // ----- Wire events -----
  btnAddPlayer.addEventListener("click", () => addPlayer(playerName.value));
  playerName.addEventListener("keydown", (e) => { if (e.key === "Enter") addPlayer(playerName.value); });

  btnAddTeam.addEventListener("click", () => addTeam(teamName.value));
  teamName.addEventListener("keydown", (e) => { if (e.key === "Enter") addTeam(teamName.value); });

  btnAutoGroup.addEventListener("click", autoGroup);
  modePlayer.addEventListener("click", () => setMode("player"));
  modeTeam.addEventListener("click", () => setMode("team"));
  btnReset.addEventListener("click", resetAll);
  btnExport.addEventListener("click", exportJSON);
  btnImport.addEventListener("click", importJSON);

  // dropzone for unassigned
  wireDropZone(unassignedZone, null);

  // initial render
  render();
})();
</script>

</body>
</html>
